#cloud-config
# DeCloud Relay VM Cloud-Init Configuration
# This VM serves as a WireGuard relay for CGNAT nodes
# Version: 3.0 (with comprehensive debug dashboard)

hostname: __VM_NAME__

# =====================================================
# SYSTEM PACKAGES
# =====================================================
packages:
  - wireguard
  - wireguard-tools
  - nginx
  - fail2ban
  - qemu-guest-agent
  - python3
  - python3-pip
  - curl
  - jq
  - htop
  - iftop
  - net-tools

# =====================================================
# SYSTEM CONFIGURATION
# =====================================================
write_files:
  # WireGuard configuration (includes orchestrator as peer)
  - path: /etc/wireguard/wg-relay-server.conf
    permissions: '0600'
    content: |
      [Interface]
      # Relay server listening on all interfaces
      Address = 10.20.0.254/24
      PrivateKey = __WIREGUARD_PRIVATE_KEY__
      ListenPort = 51820
      
      # Enable IP forwarding
      PostUp = iptables -A FORWARD -i wg-relay-server -j ACCEPT
      PostUp = iptables -A FORWARD -o wg-relay-server -j ACCEPT
      PostUp = iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
      PreDown = iptables -D FORWARD -i wg-relay-server -j ACCEPT
      PreDown = iptables -D FORWARD -o wg-relay-server -j ACCEPT
      PreDown = iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE
      
      # Orchestrator peer (pre-configured during provisioning)
      [Peer]
      # DeCloud Orchestrator
      PublicKey = __ORCHESTRATOR_PUBLIC_KEY__
      AllowedIPs = 10.20.0.1/32
      PersistentKeepalive = 25
      
      # NOTE: CGNAT nodes will be added dynamically by relay API

  # Store relay private key separately
  - path: /etc/wireguard/private.key
    permissions: '0600'
    content: |
      __WIREGUARD_PRIVATE_KEY__

  # Store relay public key
  - path: /etc/wireguard/public.key
    permissions: '0644'
    content: |
      __WIREGUARD_PUBLIC_KEY__

  # Nginx reverse proxy configuration
  - path: /etc/nginx/sites-available/relay-proxy
    permissions: '0644'
    content: |
      # HTTP proxy for CGNAT node traffic
      server {
          listen 80 default_server;
          listen [::]:80 default_server;
          
          server_name _;
          
          # Health check
          location /health {
              return 200 "OK\n";
              add_header Content-Type text/plain;
          }

          # Proxy to relay API (dashboard and management)
          location / {
              proxy_pass http://127.0.0.1:8080;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
          }
          
          # Proxy to CGNAT nodes (added dynamically)
          # Managed by relay API
      }

  # Relay management API
  - path: /etc/systemd/system/decloud-relay-api.service
    permissions: '0644'
    content: |
      [Unit]
      Description=DeCloud Relay Management API
      After=network.target wg-quick@wg-relay-server.service
      Wants=wg-quick@wg-relay-server.service
      
      [Service]
      Type=simple
      ExecStart=/usr/bin/python3 /opt/decloud-relay/api.py
      Restart=always
      RestartSec=10
      
      [Install]
      WantedBy=multi-user.target

  # Relay API script (Python)
  - path: /opt/decloud-relay/api.py
    permissions: '0755'
    content: |
      #!/usr/bin/env python3
      """
      DeCloud Relay Management API
      Handles dynamic CGNAT peer management
      """
      import json
      import subprocess
      import logging
      import os
      import time
      from datetime import datetime
      from http.server import HTTPServer, BaseHTTPRequestHandler
      
      logging.basicConfig(
          level=logging.INFO,
          format='%(asctime)s [%(levelname)s] %(message)s'
      )
      logger = logging.getLogger(__name__)
      
      # Relay configuration from cloud-init
      RELAY_ID = "__VM_ID__"
      RELAY_NAME = "__VM_NAME__"
      RELAY_CAPACITY = __RELAY_CAPACITY__
      RELAY_REGION = "__RELAY_REGION__"
      PUBLIC_IP = "__PUBLIC_IP__"
      WIREGUARD_PUBLIC_KEY = "__WIREGUARD_PUBLIC_KEY__"
      ORCHESTRATOR_PUBLIC_KEY = "__ORCHESTRATOR_PUBLIC_KEY__"
      
      BOOT_TIME = time.time()
      
      class RelayAPIHandler(BaseHTTPRequestHandler):
          def log_message(self, format, *args):
              logger.info("%s - %s" % (self.address_string(), format % args))
          
          def do_GET(self):
              if self.path == '/' or self.path == '/dashboard':
                  self.serve_dashboard()
              elif self.path == '/api/relay/status':
                  self.serve_status()
              elif self.path == '/api/relay/debug':
                  self.serve_debug_info()
              elif self.path == '/api/relay/wireguard':
                  self.serve_wireguard_details()
              elif self.path == '/api/relay/system':
                  self.serve_system_info()
              else:
                  self.send_error(404)
          
          def do_POST(self):
              if self.path == '/api/relay/add-peer':
                  self.add_wireguard_peer()
              elif self.path == '/api/relay/remove-peer':
                  self.remove_wireguard_peer()
              else:
                  self.send_error(404)

          def serve_dashboard(self):
              """Serve HTML dashboard with live debug information"""
              html = f"""<!DOCTYPE html>
      <html lang="en">
      <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>DeCloud Relay Dashboard - {RELAY_NAME}</title>
          <style>
              * {{
                  margin: 0;
                  padding: 0;
                  box-sizing: border-box;
              }}
              
              body {{
                  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  color: #fff;
                  padding: 20px;
                  min-height: 100vh;
              }}
              
              .container {{
                  max-width: 1400px;
                  margin: 0 auto;
              }}
              
              header {{
                  background: rgba(255, 255, 255, 0.1);
                  backdrop-filter: blur(10px);
                  border-radius: 15px;
                  padding: 30px;
                  margin-bottom: 30px;
                  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
              }}
              
              h1 {{
                  font-size: 2.5em;
                  margin-bottom: 10px;
                  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
              }}
              
              .subtitle {{
                  font-size: 1.2em;
                  opacity: 0.9;
              }}
              
              .grid {{
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
                  gap: 20px;
                  margin-bottom: 20px;
              }}
              
              .card {{
                  background: rgba(255, 255, 255, 0.1);
                  backdrop-filter: blur(10px);
                  border-radius: 15px;
                  padding: 25px;
                  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
                  border: 1px solid rgba(255, 255, 255, 0.1);
              }}
              
              .card h2 {{
                  font-size: 1.5em;
                  margin-bottom: 20px;
                  color: #ffd700;
                  border-bottom: 2px solid rgba(255, 215, 0, 0.3);
                  padding-bottom: 10px;
              }}
              
              .info-row {{
                  display: flex;
                  justify-content: space-between;
                  padding: 12px 0;
                  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
              }}
              
              .info-row:last-child {{
                  border-bottom: none;
              }}
              
              .label {{
                  font-weight: 600;
                  opacity: 0.8;
              }}
              
              .value {{
                  font-family: 'Courier New', monospace;
                  background: rgba(0, 0, 0, 0.2);
                  padding: 4px 10px;
                  border-radius: 5px;
                  word-break: break-all;
              }}
              
              .status-indicator {{
                  display: inline-block;
                  width: 12px;
                  height: 12px;
                  border-radius: 50%;
                  margin-right: 8px;
                  animation: pulse 2s infinite;
              }}
              
              .status-online {{
                  background: #00ff00;
              }}
              
              .status-warning {{
                  background: #ffaa00;
              }}
              
              .status-error {{
                  background: #ff0000;
              }}
              
              @keyframes pulse {{
                  0%, 100% {{ opacity: 1; }}
                  50% {{ opacity: 0.5; }}
              }}
              
              .peer-card {{
                  background: rgba(0, 0, 0, 0.2);
                  padding: 15px;
                  border-radius: 10px;
                  margin-bottom: 15px;
                  border-left: 4px solid #ffd700;
              }}
              
              .peer-card h3 {{
                  color: #ffd700;
                  margin-bottom: 10px;
                  font-size: 1.1em;
              }}
              
              .peer-stat {{
                  display: flex;
                  justify-content: space-between;
                  padding: 6px 0;
                  font-size: 0.9em;
              }}
              
              .metric {{
                  background: rgba(255, 215, 0, 0.1);
                  border-radius: 10px;
                  padding: 15px;
                  text-align: center;
                  margin-bottom: 15px;
              }}
              
              .metric-value {{
                  font-size: 2.5em;
                  font-weight: bold;
                  color: #ffd700;
                  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
              }}
              
              .metric-label {{
                  font-size: 0.9em;
                  opacity: 0.8;
                  margin-top: 5px;
              }}
              
              .refresh-indicator {{
                  text-align: center;
                  margin-top: 20px;
                  opacity: 0.7;
                  font-size: 0.9em;
              }}
              
              .code-block {{
                  background: rgba(0, 0, 0, 0.3);
                  padding: 12px;
                  border-radius: 8px;
                  font-family: 'Courier New', monospace;
                  font-size: 0.85em;
                  overflow-x: auto;
                  white-space: pre-wrap;
                  word-break: break-all;
              }}
              
              footer {{
                  text-align: center;
                  margin-top: 30px;
                  opacity: 0.7;
              }}
          </style>
      </head>
      <body>
          <div class="container">
              <header>
                  <h1>🌐 DeCloud Relay Dashboard</h1>
                  <div class="subtitle">
                      <span class="status-indicator status-online"></span>
                      {RELAY_NAME} • {RELAY_REGION}
                  </div>
              </header>
              
              <div class="grid">
                  <!-- Relay Identity -->
                  <div class="card">
                      <h2>📋 Relay Identity</h2>
                      <div class="info-row">
                          <span class="label">Relay ID:</span>
                          <span class="value" id="relay-id">{RELAY_ID[:16]}...</span>
                      </div>
                      <div class="info-row">
                          <span class="label">Name:</span>
                          <span class="value">{RELAY_NAME}</span>
                      </div>
                      <div class="info-row">
                          <span class="label">Region:</span>
                          <span class="value">{RELAY_REGION}</span>
                      </div>
                      <div class="info-row">
                          <span class="label">Public IP:</span>
                          <span class="value">{PUBLIC_IP}</span>
                      </div>
                      <div class="info-row">
                          <span class="label">Max Capacity:</span>
                          <span class="value">{RELAY_CAPACITY} nodes</span>
                      </div>
                  </div>
                  
                  <!-- WireGuard Configuration -->
                  <div class="card">
                      <h2>🔐 WireGuard Configuration</h2>
                      <div class="info-row">
                          <span class="label">Endpoint:</span>
                          <span class="value">{PUBLIC_IP}:51820</span>
                      </div>
                      <div class="info-row">
                          <span class="label">Tunnel IP:</span>
                          <span class="value">10.20.0.254/24</span>
                      </div>
                      <div class="info-row">
                          <span class="label">Interface:</span>
                          <span class="value">wg-relay-server</span>
                      </div>
                      <div class="info-row">
                          <span class="label">Relay Public Key:</span>
                      </div>
                      <div class="code-block" style="margin-top: 10px;">{WIREGUARD_PUBLIC_KEY}
                      </div>
                  </div>
                  
                  <!-- Orchestrator Peer -->
                  <div class="card">
                      <h2>🎯 Orchestrator Peer</h2>
                      <div class="info-row">
                          <span class="label">Status:</span>
                          <span class="value" id="orchestrator-status">
                              <span class="status-indicator status-online"></span>Connected
                          </span>
                      </div>
                      <div class="info-row">
                          <span class="label">Tunnel IP:</span>
                          <span class="value">10.20.0.1/32</span>
                      </div>
                      <div class="info-row">
                          <span class="label">Last Handshake:</span>
                          <span class="value" id="orchestrator-handshake">Loading...</span>
                      </div>
                      <div class="info-row">
                          <span class="label">Orchestrator Public Key:</span>
                      </div>
                      <div class="code-block" style="margin-top: 10px;">{ORCHESTRATOR_PUBLIC_KEY}
                      </div>
                  </div>
              </div>
              
              <!-- Live Metrics -->
              <div class="card">
                  <h2>📊 Live Metrics</h2>
                  <div class="grid">
                      <div class="metric">
                          <div class="metric-value" id="current-load">0</div>
                          <div class="metric-label">Connected CGNAT Nodes</div>
                      </div>
                      <div class="metric">
                          <div class="metric-value" id="available-slots">{RELAY_CAPACITY}</div>
                          <div class="metric-label">Available Slots</div>
                      </div>
                      <div class="metric">
                          <div class="metric-value" id="total-peers">1</div>
                          <div class="metric-label">Total Peers (incl. Orchestrator)</div>
                      </div>
                      <div class="metric">
                          <div class="metric-value" id="uptime">0d 0h 0m</div>
                          <div class="metric-label">Relay Uptime</div>
                      </div>
                  </div>
              </div>
              
              <!-- Connected CGNAT Nodes -->
              <div class="card">
                  <h2>🔗 Connected CGNAT Nodes</h2>
                  <div id="cgnat-peers">
                      <div style="text-align: center; opacity: 0.6; padding: 20px;">
                          No CGNAT nodes connected yet
                      </div>
                  </div>
              </div>
              
              <!-- System Resources -->
              <div class="card">
                  <h2>💻 System Resources</h2>
                  <div class="info-row">
                      <span class="label">CPU Usage:</span>
                      <span class="value" id="cpu-usage">Loading...</span>
                  </div>
                  <div class="info-row">
                      <span class="label">Memory Usage:</span>
                      <span class="value" id="memory-usage">Loading...</span>
                  </div>
                  <div class="info-row">
                      <span class="label">Disk Usage:</span>
                      <span class="value" id="disk-usage">Loading...</span>
                  </div>
                  <div class="info-row">
                      <span class="label">Network TX:</span>
                      <span class="value" id="network-tx">Loading...</span>
                  </div>
                  <div class="info-row">
                      <span class="label">Network RX:</span>
                      <span class="value" id="network-rx">Loading...</span>
                  </div>
              </div>
              
              <div class="refresh-indicator">
                  🔄 Auto-refreshing every 10 seconds • Last update: <span id="last-update">Never</span>
              </div>
              
              <footer>
                  <p>DeCloud Relay v3.0 • WireGuard Mesh Networking</p>
                  <p style="margin-top: 5px; font-size: 0.9em;">
                      <a href="/api/relay/status" style="color: #ffd700;">Status API</a> • 
                      <a href="/api/relay/debug" style="color: #ffd700;">Debug API</a> • 
                      <a href="/api/relay/wireguard" style="color: #ffd700;">WireGuard API</a>
                  </p>
              </footer>
          </div>
          
          <script>
              async function updateDashboard() {{
                  try {{
                      // Fetch debug information
                      const debugRes = await fetch('/api/relay/debug');
                      const debug = await debugRes.json();
                      
                      // Fetch WireGuard details
                      const wgRes = await fetch('/api/relay/wireguard');
                      const wg = await wgRes.json();
                      
                      // Fetch system information
                      const sysRes = await fetch('/api/relay/system');
                      const sys = await sysRes.json();
                      
                      // Update metrics
                      document.getElementById('current-load').textContent = debug.current_load;
                      document.getElementById('available-slots').textContent = debug.available_slots;
                      document.getElementById('total-peers').textContent = wg.peer_count;
                      document.getElementById('uptime').textContent = formatUptime(debug.uptime_seconds);
                      
                      // Update orchestrator status
                      const orchPeer = wg.peers.find(p => p.is_orchestrator);
                      if (orchPeer) {{
                          const handshake = orchPeer.last_handshake;
                          const handshakeText = handshake ? formatTimestamp(handshake) : 'Never';
                          document.getElementById('orchestrator-handshake').textContent = handshakeText;
                          
                          const isRecent = handshake && ((Date.now() / 1000) - handshake) < 180;
                          const statusHtml = isRecent 
                              ? '<span class="status-indicator status-online"></span>Connected'
                              : '<span class="status-indicator status-warning"></span>Stale';
                          document.getElementById('orchestrator-status').innerHTML = statusHtml;
                      }}
                      
                      // Update CGNAT peers
                      const cgnatPeers = wg.peers.filter(p => !p.is_orchestrator);
                      const cgnatContainer = document.getElementById('cgnat-peers');
                      
                      if (cgnatPeers.length === 0) {{
                          cgnatContainer.innerHTML = '<div style="text-align: center; opacity: 0.6; padding: 20px;">No CGNAT nodes connected yet</div>';
                      }} else {{
                          cgnatContainer.innerHTML = cgnatPeers.map(peer => `
                              <div class="peer-card">
                                  <h3>${{peer.description || 'Unknown Node'}}</h3>
                                  <div class="peer-stat">
                                      <span>Public Key:</span>
                                      <span style="font-family: monospace; font-size: 0.8em;">${{peer.public_key.substring(0, 24)}}...</span>
                                  </div>
                                  <div class="peer-stat">
                                      <span>Tunnel IP:</span>
                                      <span>${{peer.allowed_ips}}</span>
                                  </div>
                                  <div class="peer-stat">
                                      <span>Last Handshake:</span>
                                      <span>${{peer.last_handshake ? formatTimestamp(peer.last_handshake) : 'Never'}}</span>
                                  </div>
                                  <div class="peer-stat">
                                      <span>Transfer RX:</span>
                                      <span>${{formatBytes(peer.transfer_rx)}}</span>
                                  </div>
                                  <div class="peer-stat">
                                      <span>Transfer TX:</span>
                                      <span>${{formatBytes(peer.transfer_tx)}}</span>
                                  </div>
                              </div>
                          `).join('');
                      }}
                      
                      // Update system resources
                      document.getElementById('cpu-usage').textContent = sys.cpu.usage_percent.toFixed(1) + '%';
                      document.getElementById('memory-usage').textContent = 
                          `${{formatBytes(sys.memory.used)}} / ${{formatBytes(sys.memory.total)}} (${{sys.memory.percent.toFixed(1)}}%)`;
                      document.getElementById('disk-usage').textContent = 
                          `${{formatBytes(sys.disk.used)}} / ${{formatBytes(sys.disk.total)}} (${{sys.disk.percent.toFixed(1)}}%)`;
                      document.getElementById('network-tx').textContent = formatBytes(sys.network.bytes_sent);
                      document.getElementById('network-rx').textContent = formatBytes(sys.network.bytes_recv);
                      
                      // Update last update time
                      document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
                  }} catch (error) {{
                      console.error('Failed to update dashboard:', error);
                  }}
              }}
              
              function formatUptime(seconds) {{
                  const days = Math.floor(seconds / 86400);
                  const hours = Math.floor((seconds % 86400) / 3600);
                  const minutes = Math.floor((seconds % 3600) / 60);
                  return `${{days}}d ${{hours}}h ${{minutes}}m`;
              }}
              
              function formatTimestamp(timestamp) {{
                  const now = Date.now() / 1000;
                  const diff = now - timestamp;
                  
                  if (diff < 60) return `${{Math.floor(diff)}}s ago`;
                  if (diff < 3600) return `${{Math.floor(diff / 60)}}m ago`;
                  if (diff < 86400) return `${{Math.floor(diff / 3600)}}h ago`;
                  return `${{Math.floor(diff / 86400)}}d ago`;
              }}
              
              function formatBytes(bytes) {{
                  if (bytes === 0) return '0 B';
                  const k = 1024;
                  const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
                  const i = Math.floor(Math.log(bytes) / Math.log(k));
                  return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
              }}
              
              // Initial update
              updateDashboard();
              
              // Auto-refresh every 10 seconds
              setInterval(updateDashboard, 10000);
          </script>
      </body>
      </html>"""
              
              self.send_response(200)
              self.send_header('Content-Type', 'text/html')
              self.send_header('Cache-Control', 'no-cache, no-store, must-revalidate')
              self.end_headers()
              self.wfile.write(html.encode())

          def serve_status(self):
              """Legacy status endpoint for compatibility"""
              try:
                  result = subprocess.run(
                      ['wg', 'show', 'wg-relay-server'],
                      capture_output=True,
                      text=True
                  )
                  peer_count = result.stdout.count('peer:')
                  cgnat_peer_count = max(0, peer_count - 1)
                  
                  status = {
                      'relay_id': RELAY_ID,
                      'status': 'online',
                      'region': RELAY_REGION,
                      'max_capacity': RELAY_CAPACITY,
                      'current_load': cgnat_peer_count,
                      'available_slots': max(0, RELAY_CAPACITY - cgnat_peer_count)
                  }
                  
                  self.send_json_response(status)
              except Exception as e:
                  logger.exception("Error getting status")
                  self.send_error(500, str(e))

          def serve_debug_info(self):
              """Comprehensive debug information"""
              try:
                  result = subprocess.run(
                      ['wg', 'show', 'wg-relay-server'],
                      capture_output=True,
                      text=True
                  )
                  
                  peer_count = result.stdout.count('peer:')
                  cgnat_peer_count = max(0, peer_count - 1)
                  
                  uptime = time.time() - BOOT_TIME
                  
                  debug = {
                      'relay_id': RELAY_ID,
                      'relay_name': RELAY_NAME,
                      'region': RELAY_REGION,
                      'public_ip': PUBLIC_IP,
                      'wireguard_endpoint': f"{PUBLIC_IP}:51820",
                      'wireguard_public_key': WIREGUARD_PUBLIC_KEY,
                      'orchestrator_public_key': ORCHESTRATOR_PUBLIC_KEY,
                      'max_capacity': RELAY_CAPACITY,
                      'current_load': cgnat_peer_count,
                      'available_slots': max(0, RELAY_CAPACITY - cgnat_peer_count),
                      'total_peers': peer_count,
                      'uptime_seconds': int(uptime),
                      'status': 'online',
                      'version': '3.0'
                  }
                  
                  self.send_json_response(debug)
              except Exception as e:
                  logger.exception("Error getting debug info")
                  self.send_error(500, str(e))

          def serve_wireguard_details(self):
              """Detailed WireGuard peer information"""
              try:
                  result = subprocess.run(
                      ['wg', 'show', 'wg-relay-server', 'dump'],
                      capture_output=True,
                      text=True
                  )
                  
                  peers = []
                  lines = result.stdout.strip().split('\n')[1:]  # Skip header
                  
                  for line in lines:
                      parts = line.split('\t')
                      if len(parts) >= 8:
                          public_key = parts[0]
                          endpoint = parts[2] if parts[2] != '(none)' else None
                          allowed_ips = parts[3]
                          last_handshake = int(parts[4]) if parts[4] != '0' else None
                          transfer_rx = int(parts[5])
                          transfer_tx = int(parts[6])
                          
                          is_orchestrator = public_key == ORCHESTRATOR_PUBLIC_KEY
                          
                          peers.append({
                              'public_key': public_key,
                              'endpoint': endpoint,
                              'allowed_ips': allowed_ips,
                              'last_handshake': last_handshake,
                              'transfer_rx': transfer_rx,
                              'transfer_tx': transfer_tx,
                              'is_orchestrator': is_orchestrator,
                              'description': 'Orchestrator' if is_orchestrator else f'CGNAT Node ({allowed_ips})'
                          })
                  
                  response = {
                      'interface': 'wg-relay-server',
                      'public_key': WIREGUARD_PUBLIC_KEY,
                      'listening_port': 51820,
                      'peer_count': len(peers),
                      'peers': peers
                  }
                  
                  self.send_json_response(response)
              except Exception as e:
                  logger.exception("Error getting WireGuard details")
                  self.send_error(500, str(e))

          def serve_system_info(self):
              """System resource usage information"""
              try:
                  # CPU usage
                  cpu_result = subprocess.run(
                      ['top', '-bn1'],
                      capture_output=True,
                      text=True
                  )
                  cpu_line = [l for l in cpu_result.stdout.split('\n') if 'Cpu(s)' in l][0]
                  cpu_idle = float(cpu_line.split(',')[3].split()[0])
                  cpu_usage = 100.0 - cpu_idle
                  
                  # Memory usage
                  mem_result = subprocess.run(
                      ['free', '-b'],
                      capture_output=True,
                      text=True
                  )
                  mem_lines = mem_result.stdout.split('\n')[1].split()
                  mem_total = int(mem_lines[1])
                  mem_used = int(mem_lines[2])
                  mem_percent = (mem_used / mem_total) * 100
                  
                  # Disk usage
                  disk_result = subprocess.run(
                      ['df', '-B1', '/'],
                      capture_output=True,
                      text=True
                  )
                  disk_lines = disk_result.stdout.split('\n')[1].split()
                  disk_total = int(disk_lines[1])
                  disk_used = int(disk_lines[2])
                  disk_percent = float(disk_lines[4].rstrip('%'))
                  
                  # Network statistics
                  net_result = subprocess.run(
                      ['cat', '/proc/net/dev'],
                      capture_output=True,
                      text=True
                  )
                  
                  total_rx = 0
                  total_tx = 0
                  for line in net_result.stdout.split('\n'):
                      if ':' in line and 'lo' not in line:
                          parts = line.split()
                          if len(parts) >= 10:
                              total_rx += int(parts[1])
                              total_tx += int(parts[9])
                  
                  system_info = {
                      'cpu': {
                          'usage_percent': cpu_usage
                      },
                      'memory': {
                          'total': mem_total,
                          'used': mem_used,
                          'percent': mem_percent
                      },
                      'disk': {
                          'total': disk_total,
                          'used': disk_used,
                          'percent': disk_percent
                      },
                      'network': {
                          'bytes_recv': total_rx,
                          'bytes_sent': total_tx
                      }
                  }
                  
                  self.send_json_response(system_info)
              except Exception as e:
                  logger.exception("Error getting system info")
                  # Return defaults on error
                  self.send_json_response({
                      'cpu': {'usage_percent': 0},
                      'memory': {'total': 0, 'used': 0, 'percent': 0},
                      'disk': {'total': 0, 'used': 0, 'percent': 0},
                      'network': {'bytes_recv': 0, 'bytes_sent': 0}
                  })
          
          def add_wireguard_peer(self):
              """Add a CGNAT node as WireGuard peer"""
              try:
                  content_length = int(self.headers['Content-Length'])
                  post_data = self.rfile.read(content_length)
                  peer = json.loads(post_data)
                  
                  if 'public_key' not in peer or 'tunnel_ip' not in peer:
                      self.send_error(400, 'Missing public_key or tunnel_ip')
                      return
                  
                  cmd = [
                      'wg', 'set', 'wg-relay-server',
                      'peer', peer['public_key'],
                      'allowed-ips', peer['tunnel_ip'] + '/32'
                  ]
                  
                  if 'persistent_keepalive' in peer:
                      cmd.extend(['persistent-keepalive', str(peer['persistent_keepalive'])])
                  
                  result = subprocess.run(cmd, capture_output=True)
                  
                  if result.returncode == 0:
                      subprocess.run(['wg-quick', 'save', 'wg-relay-server'])
                      logger.info(f"Added WireGuard peer: {peer['public_key'][:16]}... ({peer['tunnel_ip']})")
                      self.send_json_response({'success': True, 'message': 'Peer added successfully'})
                  else:
                      error_msg = result.stderr.decode()
                      logger.error(f"Failed to add peer: {error_msg}")
                      self.send_error(500, error_msg)
              except Exception as e:
                  logger.exception("Error adding peer")
                  self.send_error(500, str(e))
          
          def remove_wireguard_peer(self):
              """Remove a CGNAT node from WireGuard peers"""
              try:
                  content_length = int(self.headers['Content-Length'])
                  post_data = self.rfile.read(content_length)
                  peer = json.loads(post_data)
                  
                  if 'public_key' not in peer:
                      self.send_error(400, 'Missing public_key')
                      return
                  
                  cmd = ['wg', 'set', 'wg-relay-server', 'peer', peer['public_key'], 'remove']
                  result = subprocess.run(cmd, capture_output=True)
                  
                  if result.returncode == 0:
                      subprocess.run(['wg-quick', 'save', 'wg-relay-server'])
                      logger.info(f"Removed WireGuard peer: {peer['public_key'][:16]}...")
                      self.send_json_response({'success': True, 'message': 'Peer removed successfully'})
                  else:
                      error_msg = result.stderr.decode()
                      logger.error(f"Failed to remove peer: {error_msg}")
                      self.send_error(500, error_msg)
              except Exception as e:
                  logger.exception("Error removing peer")
                  self.send_error(500, str(e))

          def send_json_response(self, data):
              """Helper to send JSON response"""
              self.send_response(200)
              self.send_header('Content-Type', 'application/json')
              self.send_header('Cache-Control', 'no-cache')
              self.end_headers()
              self.wfile.write(json.dumps(data, indent=2).encode())
      
      if __name__ == '__main__':
          server = HTTPServer(('0.0.0.0', 8080), RelayAPIHandler)
          logger.info("=" * 60)
          logger.info("DeCloud Relay Management API & Dashboard Started")
          logger.info("=" * 60)
          logger.info(f"Dashboard:   http://{PUBLIC_IP}:8080/")
          logger.info(f"Status API:  http://{PUBLIC_IP}:8080/api/relay/status")
          logger.info(f"Debug API:   http://{PUBLIC_IP}:8080/api/relay/debug")
          logger.info(f"WireGuard:   http://{PUBLIC_IP}:8080/api/relay/wireguard")
          logger.info("=" * 60)
          logger.info(f"Relay ID:    {RELAY_ID}")
          logger.info(f"Region:      {RELAY_REGION}")
          logger.info(f"Capacity:    {RELAY_CAPACITY} CGNAT nodes")
          logger.info(f"Endpoint:    {PUBLIC_IP}:51820")
          logger.info("=" * 60)
          server.serve_forever()

  # DeCloud relay metadata
  - path: /etc/decloud/relay-info.json
    permissions: '0644'
    content: |
      {
        "relay_id": "__VM_ID__",
        "relay_name": "__VM_NAME__",
        "region": "__RELAY_REGION__",
        "max_capacity": __RELAY_CAPACITY__,
        "wireguard_endpoint": "__PUBLIC_IP__:51820",
        "wireguard_public_key": "__WIREGUARD_PUBLIC_KEY__",
        "orchestrator_public_key": "__ORCHESTRATOR_PUBLIC_KEY__",
        "created_at": "__TIMESTAMP__",
        "version": "3.0"
      }

# =====================================================
# RUNTIME COMMANDS
# =====================================================
runcmd:
  # Enable IP forwarding (required for relay functionality)
  - echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
  - echo "net.ipv6.conf.all.forwarding=1" >> /etc/sysctl.conf
  - sysctl -p
  
  # Configure firewall (UFW)
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow 22/tcp comment "SSH"
  - ufw allow 51820/udp comment "WireGuard"
  - ufw allow 80/tcp comment "HTTP Proxy"
  - ufw allow 8080/tcp comment "Relay API"
  - ufw --force enable
  
  # Enable and start QEMU guest agent
  - systemctl enable qemu-guest-agent
  - systemctl start qemu-guest-agent
  
  # Start WireGuard (orchestrator peer already configured)
  - systemctl enable wg-quick@wg-relay-server
  - systemctl start wg-relay-server 2>/dev/null || wg-quick up wg-relay-server

  # Verify orchestrator peer is configured
  - wg show wg-relay-server | grep -A 5 "__ORCHESTRATOR_PUBLIC_KEY__" || echo "WARNING - Orchestrator peer not found!"

  # Wait for WireGuard to be fully up
  - |
    for i in {1..10}; do
      if wg show wg-relay-server &>/dev/null; then
        echo "WireGuard interface ready"
        break
      fi
      sleep 2
    done

  # Notify orchestrator that relay is ready
  - |
    cat > /usr/local/bin/notify-orchestrator.sh <<'EOF'
    #!/bin/bash
    ORCHESTRATOR_URL="__ORCHESTRATOR_URL__"
    NODE_ID="__NODE_ID__"
    RELAY_VM_ID="__VM_ID__"
    PUBLIC_KEY="__WIREGUARD_PUBLIC_KEY__"
    PUBLIC_IP="__PUBLIC_IP__"
    
    # Compute callback token (must match orchestrator's algorithm)
    MESSAGE="${NODE_ID}:${RELAY_VM_ID}"
    SECRET="${RELAY_CALLBACK_SECRET:-default-secret-change-in-production}"
    TOKEN=$(echo -n "$MESSAGE" | openssl dgst -sha256 -hmac "$SECRET" -binary | base64)
    
    # Call orchestrator callback endpoint
    curl -X POST "$ORCHESTRATOR_URL/api/relay/register-callback" \
      -H "Content-Type: application/json" \
      -H "X-Relay-Token: $TOKEN" \
      -d "{
        \"nodeId\": \"$NODE_ID\",
        \"relayVmId\": \"$RELAY_VM_ID\",
        \"wireGuardPublicKey\": \"$PUBLIC_KEY\",
        \"wireGuardEndpoint\": \"$PUBLIC_IP:51820\"
      }" \
      --max-time 10 \
      --retry 3 \
      --retry-delay 5
    
    if [ $? -eq 0 ]; then
      echo "✓ Successfully notified orchestrator - relay is now active"
    else
      echo "⚠ Failed to notify orchestrator - will retry on health check"
    fi
    EOF
    
  - chmod +x /usr/local/bin/notify-orchestrator.sh
  - /usr/local/bin/notify-orchestrator.sh &
  
  # Verify orchestrator peer is configured
  - wg show wg-relay-server | grep -A 5 "__ORCHESTRATOR_PUBLIC_KEY__" || echo "WARNING - Orchestrator peer not found!"
  
  # Configure and start Nginx
  - ln -sf /etc/nginx/sites-available/relay-proxy /etc/nginx/sites-enabled/
  - rm -f /etc/nginx/sites-enabled/default
  - nginx -t
  - systemctl enable nginx
  - systemctl restart nginx
  
  # Start relay management API
  - systemctl daemon-reload
  - systemctl enable decloud-relay-api
  - systemctl start decloud-relay-api
  
  # Configure fail2ban for SSH protection
  - systemctl enable fail2ban
  - systemctl start fail2ban
  
  # Create directory for relay API
  - mkdir -p /opt/decloud-relay
  - mkdir -p /etc/decloud
  
  # Log completion
  - 'echo "DeCloud relay VM bootstrap complete at $(date)" > /var/log/decloud-relay-bootstrap.log'
  - 'echo "Relay ID: __VM_ID__" >> /var/log/decloud-relay-bootstrap.log'
  - 'echo "Region: __RELAY_REGION__" >> /var/log/decloud-relay-bootstrap.log'
  - 'echo "WireGuard Public Key: __WIREGUARD_PUBLIC_KEY__" >> /var/log/decloud-relay-bootstrap.log'
  - 'echo "Orchestrator Public Key: __ORCHESTRATOR_PUBLIC_KEY__" >> /var/log/decloud-relay-bootstrap.log'
  - 'echo "Orchestrator peer configured: YES" >> /var/log/decloud-relay-bootstrap.log'

final_message: "DeCloud Relay VM __VM_NAME__ is ready! Dashboard: http://__PUBLIC_IP__:8080/ WireGuard endpoint: __PUBLIC_IP__:51820"