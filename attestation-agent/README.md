# DeCloud Attestation Agent

Ephemeral key attestation agent that runs inside VMs to prove resource availability.

## Directory Placement

Place this directory in your DeCloud.NodeAgent repository:

```
DeCloud.NodeAgent/
├── src/
│   ├── DeCloud.NodeAgent/
│   │   ├── CloudInit/
│   │   │   └── Templates/
│   │   │       ├── general-vm-cloudinit.yaml
│   │   │       ├── relay-vm-cloudinit.yaml
│   │   │       ├── decloud-agent-amd64.b64    ← Generated by build
│   │   │       └── decloud-agent-arm64.b64    ← Generated by build
│   │   └── ...
│   └── ...
├── attestation-agent/                          ← THIS DIRECTORY
│   ├── main.go                                 ← Source code
│   ├── build.sh                                ← Build script
│   ├── go.mod                                  ← Go module (auto-created)
│   └── README.md                               ← This file
└── ...
```

## Quick Start

### Prerequisites

Install Go 1.21 or later:

```bash
# Ubuntu/Debian
sudo apt update && sudo apt install -y golang-go

# macOS
brew install go

# Verify
go version
```

### Build and Install

```bash
cd attestation-agent

# Build for all architectures and install to CloudInit/Templates
./build.sh install
```

That's it! The next Node Agent build will include the attestation agent.

## Build Commands

```bash
# Build for current architecture only (quick test)
./build.sh

# Build for all architectures (amd64, arm64)
./build.sh all

# Create base64-encoded binaries only
./build.sh base64

# Build + encode + install to CloudInit/Templates
./build.sh install

# Clean build artifacts
./build.sh clean
```

## Output Files

After building:

```
attestation-agent/
├── bin/
│   ├── decloud-agent-amd64      # Linux x86_64 binary (~3MB)
│   ├── decloud-agent-arm64      # Linux ARM64 binary (~3MB)
│   ├── decloud-agent            # Symlink to default
│   ├── decloud-agent-amd64.b64  # Base64-encoded (~4MB)
│   ├── decloud-agent-arm64.b64  # Base64-encoded (~4MB)
│   └── decloud-agent.b64        # Default base64
```

## Manual Build (Without Script)

```bash
# Initialize module
go mod init decloud-attestation-agent

# Build for Linux AMD64
CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
    -ldflags="-s -w" \
    -trimpath \
    -o decloud-agent \
    ./main.go

# Create base64 for cloud-init
base64 -w 0 decloud-agent > decloud-agent.b64

# Copy to CloudInit templates
cp decloud-agent.b64 ../src/DeCloud.NodeAgent/CloudInit/Templates/
```

## Integration with Cloud-Init

Add to your cloud-init template (`general-vm-cloudinit.yaml`):

```yaml
write_files:
  # VM ID for attestation
  - path: /etc/decloud/vm-id
    permissions: '0644'
    content: "__VM_ID__"

  # Attestation agent binary
  - path: /usr/local/bin/decloud-agent
    permissions: '0755'
    encoding: base64
    content: |
      __ATTESTATION_AGENT_BASE64__

  # Systemd service
  - path: /etc/systemd/system/decloud-agent.service
    permissions: '0644'
    content: |
      [Unit]
      Description=DeCloud Attestation Agent
      After=network.target
      
      [Service]
      Type=simple
      ExecStart=/usr/local/bin/decloud-agent
      Restart=always
      RestartSec=5
      
      [Install]
      WantedBy=multi-user.target

runcmd:
  - mkdir -p /etc/decloud
  - systemctl daemon-reload
  - systemctl enable decloud-agent
  - systemctl start decloud-agent
```

## CloudInitTemplateService Integration

Update `CloudInitTemplateService.cs` to include the agent binary:

```csharp
private async Task<CloudInitTemplateVariables> BuildTemplateVariablesAsync(
    VmType vmType,
    VmSpec spec,
    CancellationToken ct)
{
    var variables = new CloudInitTemplateVariables
    {
        VmId = spec.Id,
        // ... other variables ...
    };

    // Load attestation agent binary based on architecture
    var arch = GetTargetArchitecture(); // "amd64" or "arm64"
    var agentFile = $"decloud-agent-{arch}.b64";
    var agentPath = Path.Combine(_templateBasePath, agentFile);
    
    if (File.Exists(agentPath))
    {
        variables.Custom["ATTESTATION_AGENT_BASE64"] = 
            await File.ReadAllTextAsync(agentPath, ct);
        
        _logger.LogDebug(
            "Loaded attestation agent for {Arch} ({Size} bytes)",
            arch, variables.Custom["ATTESTATION_AGENT_BASE64"].Length);
    }
    else
    {
        _logger.LogWarning(
            "Attestation agent not found at {Path}. " +
            "Run 'attestation-agent/build.sh install' to build it.",
            agentPath);
    }

    return variables;
}
```

## Testing the Agent

### Test Locally

```bash
# Build
./build.sh

# Run (requires Linux for /proc/* access)
./bin/decloud-agent

# In another terminal:
curl http://localhost:9999/health
```

### Test Challenge/Response

```bash
# Send a test challenge
curl -X POST http://localhost:9999/challenge \
  -H "Content-Type: application/json" \
  -d '{
    "nonce": "abc123def456",
    "timestamp": 1705412345678,
    "vmId": "test-vm",
    "expectedCores": 4,
    "expectedMemoryMb": 8192
  }'
```

Expected response:
```json
{
  "nonce": "abc123def456",
  "ephemeralPubKey": "9f8e7d...",
  "metrics": {
    "cpuCores": 4,
    "memoryKb": 8388608,
    "bootId": "xxx-yyy-zzz",
    ...
  },
  "memoryTouch": {
    "totalMs": 12.5,
    "maxPageMs": 0.8,
    ...
  },
  "timing": {
    "keyGenMs": 0.5,
    "totalMs": 25.3,
    ...
  },
  "signature": "ed25519..."
}
```

### Test in VM

After deploying a VM with the agent:

```bash
# SSH into VM
ssh user@vm-ip

# Check agent status
systemctl status decloud-agent

# Check logs
journalctl -u decloud-agent -f

# Test health endpoint
curl localhost:9999/health
```

## How It Works

```
┌─────────────────────────────────────────────────────────────┐
│ TIMELINE OF AN ATTESTATION (~30ms total)                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  T+0ms    Challenge arrives from Orchestrator               │
│  T+1ms    Generate fresh Ed25519 keypair                    │
│  T+5ms    Collect metrics from /proc/*                      │
│  T+15ms   Memory touch test (64 pages, 16MB)                │
│  T+20ms   Sign response with ephemeral private key          │
│  T+22ms   Send response                                     │
│  T+23ms   ZERO private key from memory                      │
│                                                             │
│  Key exists for ~22ms. Node can't extract it fast enough.   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## Security Properties

| Property | Mechanism |
|----------|-----------|
| No pre-computation | Random nonce per challenge |
| No key extraction | Key exists for ~20ms only |
| No replay | Nonce must match |
| No modification | Ed25519 signature |
| Resource verification | /proc/* metrics |
| Swap detection | Memory touch timing |

## Binary Size

| Architecture | Binary | Base64 |
|--------------|--------|--------|
| amd64 | ~2.8 MB | ~3.8 MB |
| arm64 | ~2.7 MB | ~3.6 MB |

The binary is statically compiled with no dependencies.

## Troubleshooting

### "Go not found"

```bash
# Install Go
sudo apt install golang-go  # Ubuntu/Debian
brew install go             # macOS
```

### "Permission denied on build.sh"

```bash
chmod +x build.sh
./build.sh
```

### "CloudInit templates directory not found"

Make sure you're running from the correct location:
```bash
cd /path/to/DeCloud.NodeAgent/attestation-agent
./build.sh install
```

### "Agent not starting in VM"

1. Check cloud-init completed: `cloud-init status`
2. Check agent installed: `ls -la /usr/local/bin/decloud-agent`
3. Check service: `systemctl status decloud-agent`
4. Check logs: `journalctl -u decloud-agent`

## License

MIT
